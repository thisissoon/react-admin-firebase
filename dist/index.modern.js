import{get as e,isEmpty as t,set as r}from"lodash";import a from"path-browserify";import n from"firebase/app";import"firebase/firestore";import"firebase/auth";import"firebase/storage";import{v4 as o}from"uuid";function s(){return(s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var a in r)Object.prototype.hasOwnProperty.call(r,a)&&(e[a]=r[a])}return e}).apply(this,arguments)}function i(e){e&&"object"==typeof e&&Object.keys(e).map(t=>{e[t]=function e(t){return t?"object"!=typeof t?t:t.toDate&&"function"==typeof t.toDate?t.toDate():Array.isArray(t)?t.map(t=>e(t)):"object"==typeof t?(Object.keys(t).map(r=>{t[r]=e(t[r])}),t):void 0:t}(e[t])})}const c=e=>{const t=e.data();return i(t),s({id:e.id},t)};function l(t,r,a){t.sort((t,n)=>{const o=e(t,r),s=e(n,r),i="asc"===a;return Number.isFinite(o)&&Number.isFinite(s)?u(o,s,i):"string"==typeof o&&"string"==typeof s?u(o.toLowerCase(),s.toLowerCase(),i):o instanceof Date&&s instanceof Date?u(o,s,i):u(!!o,!!s,i)})}function u(e,t,r){return e>t?r?1:-1:e<t?r?-1:1:0}function d(r,a){if(!a||t(a))return r;const n=[];return Object.keys(a).map(e=>{const t=function(e,t){if(!t||"string"==typeof t||"number"==typeof t||"boolean"==typeof t)return[{searchField:e,searchValue:t}];const r={};return r[e]=t,function(e){var t=[];return function e(r,a){for(var n in a=a||"",r)if(r.hasOwnProperty(n)){const o=r&&r[n],s=a?a+"."+n:n;"object"==typeof o||o instanceof Array?e(o,s):t.push({searchField:s,searchValue:o})}}(e,null),t}(r)}(e,a[e]);n.push(...t)}),r.filter(t=>n.reduce((r,a)=>function(t,r,a){const n=e(t,r);return!n&&!a||!!n&&("string"==typeof a?n.toString().toLowerCase().includes(a.toLowerCase()):("boolean"==typeof a||"number"==typeof a)&&n===a)}(t,a.searchField,a.searchValue)&&r,!0))}const p=(...e)=>null;class h{constructor(e,t){this.title=e,this.cacheEnabledKey=t}isEnabled(){return!!localStorage.getItem(this.cacheEnabledKey)}SetEnabled(e){e?localStorage.setItem(this.cacheEnabledKey,"true"):localStorage.removeItem(this.cacheEnabledKey)}get log(){return this.isEnabled()?console.log.bind(console,this.title):p}get warn(){return this.isEnabled()?console.warn.bind(console,this.title):p}get error(){return this.isEnabled()?console.error.bind(console,this.title):p}}const g=new h("ðŸ”¥raf:","LOGGING_ENABLED"),f=g.log,m=g.error,y=g.warn,w=new h("ðŸ’¸firestore-costs:","LOGGING_FIRESTORE_COSTS_ENABLED"),b="firecosts-single-reads",P=async(e,t)=>{const r=Array.isArray(t),a=!r&&"object"==typeof t;if(a&&t&&t.hasOwnProperty("src")){if(t.src.startsWith("https://"))return t;let r=null;try{return r=e.storage().ref(t.src),s({},t,{src:await r.getDownloadURL()})}catch(e){return m("Error when getting download URL",{error:e,fieldValue:t,ref:r}),t}}else{if(a){for(let r in t)if(t.hasOwnProperty(r)){const a=t[r];t[r]=await P(e,a)}return t}if(r){for(let r=0;r<t.length;r++)t[r]=await P(e,t[r]);return t}}return t};function R(e,t){if(!e)return t+"";if(!t)throw new Error("Resource name must be a string of length greater than 0 characters");const r="string"==typeof e?e:e(),n=a.join("/",r,"/",t,"/");if((n.split("/").length-1)%2)throw new Error('The rootRef path must point to a "document"\n    not a "collection"e.g. /collection/document/ or\n    /collection/document/collection/document/');return n.slice(1,-1)}class v{constructor(){this.firestore=null,this.app=null,this.options={}}GetApp(){return this.app}init(e,t){const r=t||{};this.options=r,this.app=function(e,t){return t.app?t.app:n.apps.length?n.app():n.initializeApp(e)}(e,r),this.firestore=this.app.firestore()}db(){return this.firestore}serverTimestamp(){return new Date}auth(){return this.app.auth()}storage(){return this.app.storage()}async GetUserLogin(){return new Promise((e,t)=>{this.app.auth().onAuthStateChanged(r=>{r?e(r):t("getUserLogin() no user logged in")})})}OnUserLogout(e){this.app.auth().onAuthStateChanged(t=>{const r=!t;f("FirebaseWrapper.OnUserLogout",{user:t,isLoggedOut:r}),r&&e(t)})}}class G{constructor(e,t,r){this.fireWrapper=e,this.options=t,this.flogger=r,this.resources={},this.db=e.db(),this.fireWrapper.OnUserLogout(()=>{this.resources={}})}async TryGetResource(e,t,r){return t&&await this.RefreshResource(e,r),this.TryGetResourcePromise(e,r)}GetResource(e){const t=this.resources[e];if(!t)throw new Error(`react-admin-firebase: Can't find resource: "${e}"`);return t}async TryGetResourcePromise(e,t){f("resourceManager.TryGetResourcePromise",{relativePath:e,collectionQuery:t}),await this.initPath(e);const r=this.resources[e];if(!r)throw new Error(`react-admin-firebase: Cant find resource: "${e}"`);return r}async RefreshResource(e,t){var r,a;if(null!=(r=this.options)&&null!=(a=r.lazyLoading)&&a.enabled)throw y("resourceManager.RefreshResource",{warn:"RefreshResource is not available in lazy loading mode"}),new Error("react-admin-firebase: RefreshResource is not available in lazy loading mode");f("resourceManager.RefreshResource",{relativePath:e,collectionQuery:t}),await this.initPath(e);const n=this.resources[e],o=n.collection,s=this.applyQuery(o,t),i=await s.get();n.list=i.docs.map(e=>this.parseFireStoreDocument(e)),this.flogger.logDocument(i.docs.length)(),f("resourceManager.RefreshResource",{newDocs:i,resource:n,collectionPath:o.path})}async GetSingleDoc(e,t){await this.initPath(e);const r=this.GetResource(e);this.flogger.logDocument(1)();const a=await r.collection.doc(t).get();if(!a.exists)throw new Error("react-admin-firebase: No id found matching: "+t);const n=this.parseFireStoreDocument(a);return f("resourceManager.GetSingleDoc",{relativePath:e,resource:r,docId:t,docSnap:a,result:n}),n}async initPath(e){const t=R(this.options&&this.options.rootRef,e),r=!!this.resources[e];if(f("resourceManager.initPath()",{absolutePath:t,hasBeenInited:r}),r)return void f("resourceManager.initPath() has been initialized already...");const a=this.db.collection(t),n={collection:a,list:[],path:e,pathAbsolute:t};this.resources[e]=n,f("resourceManager.initPath() setting resource...",{resource:n,allResources:this.resources,collection:a,collectionPath:a.path})}parseFireStoreDocument(e){if(!e)return y("parseFireStoreDocument: no doc",{doc:e}),{};const t=e.data();return i(t),s({id:e.id},t)}async getUserIdentifier(){return this.options.associateUsersById?await this.getCurrentUserId():await this.getCurrentUserEmail()}async getCurrentUserEmail(){const e=await this.fireWrapper.GetUserLogin();return e?e.email:"annonymous user"}async getCurrentUserId(){const e=await this.fireWrapper.GetUserLogin();return e?e.uid:"annonymous user"}applyQuery(e,t){const r=t?t(e):e;return f("resourceManager.applyQuery() ...",{collection:e,collectionQuery:(t||"-").toString(),collRef:r}),r}}class F{constructor(e,t,r){this.fireWrapper=e,this.options=t,this.flogger=r,this.rm=new G(this.fireWrapper,this.options,this.flogger)}db(){return this.fireWrapper.db()}checkRemoveIdField(e,t){this.options.dontAddIdFieldToDoc||(e.id=t)}async parseDataAndUpload(e,t,a){var n=this;if(!a)return a;const o=e.collection.doc(t).path,s=function(e){if(!e||"object"!=typeof e)return[];const t=[];return Object.keys(e).map(r=>{!function e(t,r,a){return t?"object"!=typeof t?t:t.toDate&&"function"==typeof t.toDate?t.toDate():Array.isArray(t)?t.map((t,n)=>e(t,`${r}.${n}`,a)):"object"==typeof t?t&&t.hasOwnProperty("rawFile")?(a.push({fieldDotsPath:r,fieldSlashesPath:r.split(".").join("/"),rawFile:t.rawFile}),void delete t.rawFile):(Object.keys(t).map(n=>{e(t[n],`${r}.${n}`,a)}),t):void 0:t}(e[r],r,t)}),t}(a);return await Promise.all(s.map(async function(e){const t=await n.uploadAndGetLink(e.rawFile,o,e.fieldSlashesPath,!!n.options.useFileNamesInStorage);r(a,e.fieldDotsPath+".src",null==t?void 0:t.src),r(a,e.fieldDotsPath+".id",null==t?void 0:t.id)})),a}async addCreatedByFields(e){return async function(e,t,r,a){if(a.disableMeta)return;const n=await r.getUserIdentifier(),o=function(e){if(e.renameMetaFields&&e.renameMetaFields.created_at)return e.renameMetaFields.created_at;const t=e.metaFieldCasing;return t?"camel"===t?"createDate":"snake"===t?"create_date":"pascal"===t?"CreateDate":"kebab"===t?"create-date":"createdate":"createdate"}(a),s=function(e){if(e.renameMetaFields&&e.renameMetaFields.created_by)return e.renameMetaFields.created_by;const t=e.metaFieldCasing;return t?"camel"===t?"createdBy":"snake"===t?"created_by":"pascal"===t?"CreatedBy":"kebab"===t?"created-by":"createdby":"createdby"}(a);e[o]=t.serverTimestamp(),e[s]=n}(e,this.fireWrapper,this.rm,this.options)}async addUpdatedByFields(e){return async function(e,t,r,a){if(a.disableMeta)return;const n=await r.getUserIdentifier(),o=function(e){if(e.renameMetaFields&&e.renameMetaFields.updated_at)return e.renameMetaFields.updated_at;const t=e.metaFieldCasing;return t?"camel"===t?"lastUpdate":"snake"===t?"last_update":"pascal"===t?"LastUpdate":"kebab"===t?"last-update":"lastupdate":"lastupdate"}(a),s=function(e){if(e.renameMetaFields&&e.renameMetaFields.updated_by)return e.renameMetaFields.updated_by;const t=e.metaFieldCasing;return t?"camel"===t?"updatedBy":"snake"===t?"updated_by":"pascal"===t?"UpdatedBy":"kebab"===t?"updated-by":"updatedby":"updatedby"}(a);e[o]=t.serverTimestamp(),e[s]=n}(e,this.fireWrapper,this.rm,this.options)}async uploadAndGetLink(e,t,r,a){const n=o(),s=`${n}/${n}`;return console.log("storage path",s),{id:n,src:await this.saveFile(s,e)||""}}async saveFile(e,t){f("saveFile() saving file...",{storagePath:e,rawFile:t});const r=this.fireWrapper.storage().ref(e).put(t);try{const t=await new Promise((e,t)=>r.then(e).catch(t)),a=await t.ref.getDownloadURL();return f("saveFile() saved file",{storagePath:e,taskResult:t,getDownloadURL:a}),this.options.relativeFilePaths?e:a}catch(e){m("storage/unknown"===e.code?'saveFile() error saving file, No bucket found! Try clicking "Get Started" in firebase -> storage':"saveFile() error saving file",{storageError:e})}}}async function L(e,t,r,a){const n=btoa(JSON.stringify(s({},t,{resourceName:r}))),o=localStorage.getItem(n);if(!o)return!1;const i=await e.doc(o).get();return a.logDocument(1)(),!!i.exists&&i}const T={filters:!0,sort:!0,pagination:!0};async function A(e,t,r,a,n=T){const o=n.filters?(i=e,c=t.filter,Object.keys(c).forEach(e=>{i=i.where(e,"==",c[e])}),i):e;var i,c;const l=n.sort?function(e,t){if(null!=t&&"id"!==t.field){const{field:r,order:a}=t,n=a.toLocaleLowerCase();e=e.orderBy(r,n)}return e}(o,t.sort):o;return n.pagination?async function(e,t,r,a,n){const{page:o,perPage:i}=t.pagination;if(1===o)e=e.limit(i);else{let o=await L(r,t,a,n);o||(o=await async function(e,t,r,a,n){const{page:o,perPage:i}=r.pagination;let c=!1,l=o-1;const u=s({},r,{pagination:s({},r.pagination)});for(;!c&&l>1;)l--,u.pagination.page=l,console.log("getting query cursor currentPage=",l),c=await L(e,u,a,n);const d=(o-l)*i,p=1===l?t.limit(d):t.startAt(c).limit(d),h=await p.get(),g=h.docs.length;return n.logDocument(g)(),h.docs[g-1]}(r,e,t,a,n)),e=e.startAfter(o).limit(i)}return e}(l,t,e,r,a):l}function S(e,t){return s({},e,{filter:t?s({deleted:!1},e.filter):e.filter})}class D{constructor(e,t,r){this.options=e,this.rm=t,this.client=r}async apiGetList(e,t){var r=this;const a=await this.tryGetResource(e),n=S(t,!!this.options.softDelete);f("apiGetListLazy",{resourceName:e,params:n});const o=await A(a.collection,n,e,this.client.flogger),i=await o.get(),l=i.docs.length;if(!l)return f("apiGetListLazy",{message:"There are not records for given query"}),{data:[],total:0};this.client.flogger.logDocument(l)();const u=i.docs.map(c),d=i.docs[i.docs.length-1];!function(e,t,r){const a=btoa(JSON.stringify(s({},t,{resourceName:r})));localStorage.setItem(a,e.id);const n="ra-firebase-cursor-keys_"+r,o=localStorage.getItem(n);if(o){const e=JSON.parse(o).concat(a);localStorage.setItem(n,JSON.stringify(e))}else localStorage.setItem(n,JSON.stringify([a]))}(d,function(e){return s({},e,{pagination:s({},e.pagination,{page:e.pagination.page+1})})}(n),e);let p=9e3;if(await this.checkIfOnLastPage(a.collection,n,e,d)){const{page:e,perPage:t}=n.pagination;p=(e-1)*t+u.length,f("apiGetListLazy",{message:"It's last page of collection."})}if(this.options.relativeFilePaths){const e=await Promise.all(u.map(async function(e){for(let t in e)e[t]=await P(r.client.fireWrapper,e[t]);return e}));return f("apiGetListLazy result",{docs:e,resource:a,collectionPath:a.collection.path}),{data:e,total:p}}return f("apiGetListLazy result",{docs:u,resource:a,collectionPath:a.collection.path}),{data:u,total:p}}async apiGetManyReference(e,t){var r=this;const a=await this.tryGetResource(e);f("apiGetManyReferenceLazy",{resourceName:e,resource:a,reactAdminParams:t});const n=s({},t.filter,{[t.target]:t.id}),o=S(s({},t,{filter:n}),!!this.options.softDelete),i=await A(a.collection,o,e,this.client.flogger),l=await i.get();this.client.flogger.logDocument(l.docs.length)();const u=l.docs.map(c);if(this.options.relativeFilePaths){const e=await Promise.all(u.map(async function(e){for(let t in e)e[t]=await P(r.client.fireWrapper,e[t]);return e}));return f("apiGetManyReferenceLazy result",{docs:e,resource:a,collectionPath:a.collection.path}),{data:e,total:u.length}}return f("apiGetManyReferenceLazy result",{docs:u,resource:a,collectionPath:a.collection.path}),{data:u,total:u.length}}async checkIfOnLastPage(e,t,r,a){const n=await A(e,t,r,this.client.flogger,{filters:!0,sort:!0});if(!a)throw new Error("Page cursor was empty...");return(await n.startAfter(a).limit(1).get()).empty}clearQueryCursors(e){!function(e){const t="ra-firebase-cursor-keys_"+e,r=localStorage.getItem(t);r&&(JSON.parse(r).forEach(e=>localStorage.removeItem(e)),localStorage.removeItem(t))}(e)}async tryGetResource(e,t){return this.rm.TryGetResourcePromise(e,t)}}function I(e,t){var r,a;const n=t||{};!function(e,t){if(!(e||t&&t.app))throw new Error("Please pass the Firebase firebaseConfig object or options.app to the FirebaseAuthProvider");t&&t.rootRef&&R(t.rootRef,"test")}(e,n);const o=function(e){return{SetEnabled(e){w.SetEnabled(e)},ResetCount(e){e&&localStorage.removeItem(b)},logDocument(t){if(null==e||null==(r=e.lazyLoading)||!r.enabled)return p;var r;const a=function(e=1){const t=localStorage.getItem(b)||"",r=(parseInt(t)||0)+e;return localStorage.setItem(b,r+""),r}(t);return w.log.bind(console,`+${t} (session total=${a} documents read)`)}}}(n);g.SetEnabled(!(null==n||!n.logging)),o.SetEnabled(!(null==n||null==(r=n.firestoreCostsLogger)||!r.enabled)),o.ResetCount(!(null!=n&&null!=(a=n.firestoreCostsLogger)&&a.persistCount)),f("Creating FirebaseDataProvider",{firebaseConfig:e,options:n});const i=new v;async function c(e){let t;try{return t=await e(),t}catch(e){const r=e.toString(),a=function(e){const t=/\[code\=([\w-]*)/g.exec(e),r=Array.isArray(t)&&t[1];switch(r||m("unknown StatusCode ",{statusTxt:e}),r){case"unauthenticated":return 401;case"permission-denied":return 403;case"internal":return 0;case"invalid-argument":return 400;case"not-found":return 404;case"aborted":return 409;case"resource-exhausted":return 429;case"cancelled":return 499;case"internal":return 500;case"unimplemented":return 501;case"unavailable":return 503;case"deadline-exceeded":return 504;default:return 200}}(r),n={status:a,message:r,json:t};throw m("DataProvider:",e,{errorMsg:r,code:a,errorObj:n}),n}}i.init(e,t);const u=new F(i,n,o);return{app:i.GetApp(),getList:(e,t)=>c(()=>async function(e,t,r){var a;f("GetList",{resourceName:e,params:t});const{rm:n,fireWrapper:o,options:s}=r;if(null!=s&&null!=(a=s.lazyLoading)&&a.enabled)return new D(s,n,r).apiGetList(e,t);const i=t.filter||{},c=i.collectionQuery;delete i.collectionQuery;const u=(await n.TryGetResource(e,"REFRESH",c)).list;if(null!=t.sort){const{field:e,order:r}=t.sort;l(u,e,"ASC"===r?"asc":"desc")}let p=u;s.softDelete&&!Object.keys(i).includes("deleted")&&(p=u.filter(e=>!e.deleted));const h=d(p,i),g=(t.pagination.page-1)*t.pagination.perPage,m=h.slice(g,g+t.pagination.perPage),y=h.length;return s.relativeFilePaths?{data:await Promise.all(m.map(e=>P(o,e))),total:y}:{data:m,total:y}}(e,t,u)),getOne:(e,t)=>c(()=>async function(e,t,r){f("GetOne",{resourceName:e,params:t});const{rm:a,fireWrapper:n}=r;try{const o=t.id+"",s=await a.GetSingleDoc(e,o);return r.flogger.logDocument(1)(),{data:await P(n,s)}}catch(r){throw new Error("Error getting id: "+t.id+" from collection: "+e)}}(e,t,u)),getMany:(e,t)=>c(()=>async function(e,t,r){const{rm:a,options:n,fireWrapper:o}=r,i=await a.TryGetResource(e);f("GetMany",{resourceName:e,resource:i,params:t});const c=t.ids,l=await Promise.all(c.map(e=>i.collection.doc(e+"").get()));r.flogger.logDocument(c.length)();const u=l.map(e=>s({},e.data(),{id:e.id})),d=n.softDelete?u.filter(e=>!e.deleted):u;return n.relativeFilePaths?{data:await Promise.all(d.map(e=>P(o,e)))}:{data:d}}(e,t,u)),getManyReference:(e,t)=>c(()=>async function(e,t,r){const{rm:a,options:n,fireWrapper:o}=r;f("GetManyReference",{resourceName:e,params:t});const s=t.filter||{},i=s.collectionQuery,c=await a.TryGetResource(e,"REFRESH",i);delete s.collectionQuery,f("apiGetManyReference",{resourceName:e,resource:c,params:t});const u=c.list,p=t.target,h=t.id;let g=u;n.softDelete&&(g=u.filter(e=>!e.deleted));const m=d(g,s),y={};y[p]=h;const w=d(m,y);if(null!=t.sort){const{field:e,order:r}=t.sort;l(w,e,"ASC"===r?"asc":"desc")}const b=(t.pagination.page-1)*t.pagination.perPage,R=w.slice(b,b+t.pagination.perPage),v=w.length;return n.relativeFilePaths?{data:await Promise.all(w.map(e=>P(o,e))),total:v}:{data:R,total:v}}(e,t,u)),update:(e,t)=>c(()=>async function(e,t,r){const{rm:a}=r;f("Update",{resourceName:e,params:t});const n=t.id+"";delete t.data.id;const o=await a.TryGetResource(e);f("Update",{resourceName:e,resource:o,params:t});const i=await r.parseDataAndUpload(o,n,t.data),c=s({},i);return r.checkRemoveIdField(c,n),await r.addUpdatedByFields(c),await o.collection.doc(n).update(c),{data:s({},i,{id:n})}}(e,t,u)),updateMany:(e,t)=>c(()=>async function(e,t,r){const{rm:a}=r;f("UpdateMany",{resourceName:e,params:t}),delete t.data.id;const n=await a.TryGetResource(e);f("UpdateMany",{resourceName:e,resource:n,params:t});const o=t.ids;return{data:await Promise.all(o.map(async e=>{const a=e+"",o=await r.parseDataAndUpload(n,a,t.data),i=s({},o);return r.checkRemoveIdField(i,a),await r.addUpdatedByFields(i),await n.collection.doc(a).update(i),s({},o,{id:a})}))}}(e,t,u)),create:(e,t)=>c(()=>async function(e,t,r){const{rm:a,fireWrapper:n}=r,o=await a.TryGetResource(e);f("Create",{resourceName:e,resource:o,params:t});const i=t.data&&t.data.id;if(f("Create",{hasOverridenDocId:i}),i){const e=t.data.id;if((await o.collection.doc(e).get()).exists)throw new Error(`the id:"${e}" already exists, please use a unique string if overriding the 'id' field`);const a=await r.parseDataAndUpload(o,e,t.data);if(!e)throw new Error("id must be a valid string");const n=s({},a);return r.checkRemoveIdField(n,e),await r.addCreatedByFields(n),await r.addUpdatedByFields(n),f("Create",{docObj:n}),await o.collection.doc(e).set(n,{merge:!1}),{data:s({},a,{id:e})}}const c=n.db().collection("collections").doc().id,l=await r.parseDataAndUpload(o,c,t.data),u=s({},l);return r.checkRemoveIdField(u,c),await r.addCreatedByFields(u),await r.addUpdatedByFields(u),await o.collection.doc(c).set(u,{merge:!1}),{data:s({},l,{id:c})}}(e,t,u)),delete:(e,t)=>c(()=>async function(e,t,r){const{rm:a,options:n}=r;if(n.softDelete)return async function(e,t,r){const{rm:a}=r,n=t.id+"",o=await a.TryGetResource(e);f("DeleteSoft",{resourceName:e,resource:o,params:t});const s={deleted:!0};return await r.addUpdatedByFields(s),o.collection.doc(n).update(s).catch(e=>{m("DeleteSoft error",{error:e})}),{data:t.previousData}}(e,t,r);const o=await a.TryGetResource(e);f("apiDelete",{resourceName:e,resource:o,params:t});try{const e=t.id+"";await o.collection.doc(e).delete()}catch(e){throw new Error(e)}return{data:t.previousData}}(e,t,u)),deleteMany:(e,t)=>c(()=>async function(e,t,r){const{options:a,rm:n,fireWrapper:o}=r;if(a.softDelete)return async function(e,t,r){const{rm:a}=r,n=await a.TryGetResource(e);f("DeleteManySoft",{resourceName:e,resource:n,params:t});const o=t.ids;return{data:await Promise.all(o.map(async e=>{const t=e+"",a={deleted:!0};return await r.addUpdatedByFields(a),n.collection.doc(t).update(a).catch(e=>{m("apiSoftDeleteMany error",{error:e})}),t}))}}(e,t,r);const s=await n.TryGetResource(e);f("DeleteMany",{resourceName:e,resource:s,params:t});const i=[],c=o.db().batch();for(const e of t.ids){const t=s.collection.doc(e+"");c.delete(t),i.push(e)}try{await c.commit()}catch(e){throw new Error(e)}return{data:i}}(e,t,u))}}class k{constructor(e,t){const r=t||{};f("Auth Client: initializing...",{firebaseConfig:e,options:r});const a=new v;a.init(e,r),this.auth=a.auth(),r.persistence&&this.setPersistence(r.persistence)}setPersistence(e){let t;switch(e){case"local":t=n.auth.Auth.Persistence.LOCAL;break;case"none":t=n.auth.Auth.Persistence.NONE;break;case"session":default:t=n.auth.Auth.Persistence.SESSION}f("setPersistence",{persistenceInput:e,persistenceResolved:t}),this.auth.setPersistence(t).catch(e=>console.error(e))}async HandleAuthLogin(e){const{username:t,password:r}=e;if(!t||!r)return this.getUserLogin();try{const e=await this.auth.signInWithEmailAndPassword(t,r);return f("HandleAuthLogin: user sucessfully logged in",{user:e}),e}catch(t){throw f("HandleAuthLogin: invalid credentials",{params:e}),new Error("Login error: invalid credentials")}}HandleAuthLogout(){return this.auth.signOut()}HandleAuthError(e){return f("HandleAuthLogin: invalid credentials",{errorHttp:e}),"ok"===function(e){if(e>=200&&e<300)return"ok";switch(e){case 401:case 403:return"unauthenticated";case 0:case 400:case 404:case 409:case 429:case 499:case 500:case 501:case 503:case 504:default:return"ok"}}(!!e&&e.status)?(f("API is actually authenticated"),Promise.resolve()):(y("Recieved authentication error from API"),Promise.reject())}async HandleAuthCheck(){return this.getUserLogin()}getUserLogin(){return new Promise((e,t)=>{if(this.auth.currentUser)return e(this.auth.currentUser);const r=this.auth.onAuthStateChanged(a=>{r(),a?e(a):t()})})}async HandleGetPermissions(){try{const e=await this.getUserLogin();return(await e.getIdTokenResult()).claims}catch(e){return f("HandleGetPermission: no user is logged in or tokenResult error",{e}),null}}async HandleGetIdentity(){try{const{uid:e,displayName:t,photoURL:r}=await this.getUserLogin();return{id:e,fullName:""+(null!=t?t:""),avatar:""+(null!=r?r:"")}}catch(e){return f("HandleGetIdentity: no user is logged in",{e}),null}}async HandleGetJWTAuthTime(){try{const e=await this.getUserLogin();return(await e.getIdTokenResult()).authTime}catch(e){return f("HandleGetJWTAuthTime: no user is logged in or tokenResult error",{e}),null}}async HandleGetJWTExpirationTime(){try{const e=await this.getUserLogin();return(await e.getIdTokenResult()).expirationTime}catch(e){return f("HandleGetJWTExpirationTime: no user is logged in or tokenResult error",{e}),null}}async HandleGetJWTSignInProvider(){try{const e=await this.getUserLogin();return(await e.getIdTokenResult()).signInProvider}catch(e){return f("HandleGetJWTSignInProvider: no user is logged in or tokenResult error",{e}),null}}async HandleGetJWTIssuedAtTime(){try{const e=await this.getUserLogin();return(await e.getIdTokenResult()).issuedAtTime}catch(e){return f("HandleGetJWTIssuedAtTime: no user is logged in or tokenResult error",{e}),null}}async HandleGetJWTToken(){try{const e=await this.getUserLogin();return(await e.getIdTokenResult()).token}catch(e){return f("HandleGetJWTIssuedAtTime: no user is logged in or tokenResult error",{e}),null}}}function E(e,t){!function(e,t){if(!(e||t&&t.app))throw new Error("Please pass the Firebase firebaseConfig object or options.app to the FirebaseAuthProvider")}(e,t),g.SetEnabled(!(null==t||!t.logging));const r=new k(e,t);return{login:e=>r.HandleAuthLogin(e),logout:()=>r.HandleAuthLogout(),checkAuth:()=>r.HandleAuthCheck(),checkError:e=>r.HandleAuthError(e),getPermissions:()=>r.HandleGetPermissions(),getIdentity:()=>r.HandleGetIdentity(),getAuthUser:()=>r.getUserLogin(),getJWTAuthTime:()=>r.HandleGetJWTAuthTime(),getJWTExpirationTime:()=>r.HandleGetJWTExpirationTime(),getJWTSignInProvider:()=>r.HandleGetJWTSignInProvider(),getJWTClaims:()=>r.HandleGetPermissions(),getJWTToken:()=>r.HandleGetJWTToken()}}export{E as FirebaseAuthProvider,I as FirebaseDataProvider};
//# sourceMappingURL=index.modern.js.map
